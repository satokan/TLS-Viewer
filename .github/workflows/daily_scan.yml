name: Daily SSL/TLS Scan

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of domains to scan (default: 50)'
        required: false
        default: '50'
      scan_all:
        description: 'Scan ALL domains (WARNING: May timeout)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scan-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libssl-dev

      - name: Build and Install liboqs
        run: |
          git clone --branch main --single-branch https://github.com/open-quantum-safe/liboqs.git
          cd liboqs
          mkdir build && cd build
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
          ninja
          sudo ninja install
          sudo ldconfig

      - name: Install pqcscan
        run: |
          # Clone from Anvil Secure (Rust project)
          git clone https://github.com/anvilsecure/pqcscan.git
          cd pqcscan
          
          echo "Building pqcscan (Rust)..."
          cargo build --release
          
          # Install
          mkdir -p ~/.local/bin
          cp target/release/pqcscan ~/.local/bin/
          chmod +x ~/.local/bin/pqcscan
          
          # Verify
          ls -l ~/.local/bin/pqcscan
          ~/.local/bin/pqcscan --version || true
        continue-on-error: false

      - name: Download GeoIP DB
        env:
          GEOIP_LICENSE_KEY: ${{ secrets.GEOIP_LICENSE_KEY }}
        run: |
          mkdir -p data
          if [ -n "$GEOIP_LICENSE_KEY" ]; then
            echo "Downloading GeoIP database..."
            curl -L "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=${GEOIP_LICENSE_KEY}&suffix=tar.gz" -o GeoLite2-City.tar.gz
            tar -xzf GeoLite2-City.tar.gz
            mv GeoLite2-City_*/GeoLite2-City.mmdb data/
            rm -rf GeoLite2-City*
            echo "GeoIP database installed."
          else
            echo "GEOIP_LICENSE_KEY not set. GeoIP resolution will be disabled."
          fi

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # Optional: Restore database from cache or previous commit
      # For now, we start fresh or use what's in the repo (if committed)
      # To persist data across runs, we'd need to commit scanner.db back to the repo
      
      - name: Run Database Migrations
        run: |
          alembic upgrade head
        env:
          PYTHONPATH: .

      - name: Run Scan
        run: |
          # Determine arguments
          LIMIT="${{ inputs.limit }}"
          
          # Set default limit based on event type if input is empty
          if [ -z "$LIMIT" ]; then
            if [ "${{ github.event_name }}" == "schedule" ]; then
              LIMIT="1000"
              echo "Scheduled run detected. Setting limit to 1000."
            else
              LIMIT="50"
              echo "Manual run (no input). Setting default limit to 50."
            fi
          fi
          
          ARGS="--limit $LIMIT"
          
          if [ "${{ inputs.scan_all }}" == "true" ]; then
            ARGS="--all"
          fi
          
          echo "Running scan with args: $ARGS"
          python run_scan.py $ARGS
        env:
          PYTHONPATH: .

      - name: Generate Dashboard
        run: |
          python generator/main.py
        env:
          PYTHONPATH: .

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'output'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
